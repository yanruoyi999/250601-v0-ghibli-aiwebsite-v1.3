<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghibli AI 完整功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .result {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success { border-left: 5px solid #4caf50; }
        .error { border-left: 5px solid #f44336; }
        .loading { border-left: 5px solid #ff9800; }
        img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        .progress-container {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🎨 Ghibli AI 顶级质量图片生成器 - 完整测试</h1>
    
    <div class="test-section">
        <h2>🧪 API功能测试</h2>
        <button onclick="testAllAspectRatios()">测试所有比例</button>
        <button onclick="testQualityModes()">测试质量模式</button>
        <button onclick="testAnatomyFocus()">测试解剖学优化</button>
        <button onclick="testComplexScenes()">测试复杂场景</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>🎯 顶级质量生成测试</h2>
        <button onclick="generateWithProgress('a beautiful girl with perfect hands and face sitting in a magical garden', '3:4', 'hd')">HD质量人物测试</button>
        <button onclick="generateWithProgress('a dragon flying over ancient temple with perfect anatomy', '16:9', 'standard')">复杂场景测试</button>
        <button onclick="generateWithProgress('two characters interacting naturally without overlapping', '1:1', 'hd')">交互场景测试</button>
        
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        
        <div id="generation-results"></div>
    </div>

    <div class="test-section">
        <h2>🎯 真实吉卜力风格生成测试</h2>
        <button onclick="generateWithProgress('a young girl reading under a cherry blossom tree', '3:4', 'standard')">樱花树下阅读</button>
        <button onclick="generateWithProgress('peaceful countryside village with rolling green hills', '16:9', 'hd')">田园村庄风景</button>
        <button onclick="generateWithProgress('cat sitting by a wooden window with soft sunlight', '1:1', 'standard')">窗边小猫</button>
        <button onclick="generateWithProgress('child walking through a field of wildflowers', '3:4', 'hd')">野花田间漫步</button>
        <button onclick="generateWithProgress('cozy wooden cottage surrounded by forest', '4:3', 'standard')">森林小屋</button>
        
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        
        <div id="generation-results"></div>
    </div>

    <div class="test-section">
        <h2>📊 性能统计</h2>
        <div id="performance-stats">
            <p>等待测试数据...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>🌟 吉卜力风格特征验证</h2>
        <button onclick="testGhibliCharacteristics()">测试风格特征</button>
        <button onclick="testColorPalette()">测试色彩柔和度</button>
        <button onclick="testNaturalElements()">测试自然元素</button>
        <div id="style-results"></div>
    </div>

    <div class="test-section">
        <h2>🔬 逻辑准确性专项测试</h2>
        <button onclick="testAnatomyAccuracy()">测试解剖学准确性</button>
        <button onclick="testObjectLogic()">测试物体逻辑</button>
        <button onclick="testFacialSymmetry()">测试面部对称性</button>
        <button onclick="testComplexInteractions()">测试复杂交互场景</button>
        <button onclick="generateWithProgress('girl riding single broomstick in sky', '3:4', 'hd')">扫帚骑行测试</button>
        <div id="logic-results"></div>
    </div>

    <script>
        let testResults = [];

        async function apiTest(prompt, aspectRatio, quality, testName) {
            const startTime = Date.now();
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, aspectRatio, quality })
                });
                
                const data = await response.json();
                const endTime = Date.now();
                
                if (data.success) {
                    testResults.push({
                        test: testName,
                        time: endTime - startTime,
                        success: true,
                        size: data.settings.size,
                        steps: data.settings.steps,
                        seed: data.performance.seed
                    });
                    return { success: true, data, time: endTime - startTime };
                } else {
                    return { success: false, error: data.error, time: endTime - startTime };
                }
            } catch (error) {
                return { success: false, error: error.message, time: Date.now() - startTime };
            }
        }

        async function testAllAspectRatios() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="result loading">测试所有比例...</div>';
            
            const ratios = [
                { ratio: '1:1', expected: '1024x1024', name: '正方形' },
                { ratio: '4:3', expected: '1152x896', name: '横向' },
                { ratio: '3:4', expected: '896x1152', name: '竖向' },
                { ratio: '16:9', expected: '1792x1024', name: '超宽' },
                { ratio: '9:16', expected: '1024x1792', name: '超高' }
            ];
            
            let results = '';
            for (const { ratio, expected, name } of ratios) {
                const result = await apiTest('a peaceful scene', ratio, 'standard', `比例测试_${ratio}`);
                if (result.success && result.data.settings.size === expected) {
                    results += `<div class="result success">✅ ${name} (${ratio}): ${result.data.settings.size} - ${result.time}ms</div>`;
                } else {
                    results += `<div class="result error">❌ ${name} (${ratio}): ${result.error || '尺寸错误'}</div>`;
                }
            }
            resultsDiv.innerHTML = results;
        }

        async function testQualityModes() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="result loading">测试质量模式...</div>';
            
            const standardResult = await apiTest('a test scene', '1:1', 'standard', '标准质量测试');
            const hdResult = await apiTest('a test scene', '1:1', 'hd', 'HD质量测试');
            
            let results = '';
            if (standardResult.success) {
                results += `<div class="result success">✅ 标准质量: ${standardResult.data.settings.steps}步 - ${standardResult.time}ms</div>`;
            }
            if (hdResult.success) {
                results += `<div class="result success">✅ HD质量: ${hdResult.data.settings.steps}步 - ${hdResult.time}ms</div>`;
            }
            
            resultsDiv.innerHTML = results;
        }

        async function testAnatomyFocus() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="result loading">测试解剖学优化...</div>';
            
            const result = await apiTest('a girl with beautiful hands and perfect facial features', '3:4', 'hd', '解剖学测试');
            
            if (result.success) {
                const hasAnatomyKeywords = result.data.prompt.includes('perfect anatomy') && 
                                         result.data.prompt.includes('five fingers per hand') &&
                                         result.data.negativePrompt.includes('extra fingers');
                
                if (hasAnatomyKeywords) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 解剖学优化已启用
                    <br>正面提示词长度: ${result.data.prompt.length}
                    <br>负面提示词长度: ${result.data.negativePrompt.length}
                    <br>生成时间: ${result.time}ms</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 解剖学关键词缺失</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 解剖学测试失败: ${result.error}</div>`;
            }
        }

        async function testComplexScenes() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="result loading">测试复杂场景...</div>';
            
            const complexPrompts = [
                'multiple characters without overlapping',
                'character holding objects with proper physics',
                'detailed architecture with correct perspective'
            ];
            
            let results = '';
            for (const prompt of complexPrompts) {
                const result = await apiTest(prompt, '16:9', 'hd', `复杂场景_${prompt.substring(0,20)}`);
                if (result.success) {
                    results += `<div class="result success">✅ ${prompt}: ${result.time}ms</div>`;
                } else {
                    results += `<div class="result error">❌ ${prompt}: ${result.error}</div>`;
                }
            }
            resultsDiv.innerHTML = results;
        }

        async function generateWithProgress(prompt, aspectRatio, quality) {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const resultsDiv = document.getElementById('generation-results');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // 模拟进度条
            let progress = 5;
            const progressInterval = setInterval(() => {
                if (progress < 85) {
                    progress += Math.random() * 8 + 2;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = Math.round(progress) + '%';
                }
            }, 300);
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, aspectRatio, quality })
                });
                
                const data = await response.json();
                const endTime = Date.now();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
                
                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            ✅ 生成成功！
                            <br>提示词: ${prompt}
                            <br>比例: ${aspectRatio} (${data.settings.size})
                            <br>质量: ${quality} (${data.settings.steps}步)
                            <br>总时间: ${endTime - startTime}ms
                            <br>推理时间: ${data.performance.apiTime}秒
                            <br>种子: ${data.performance.seed}
                            <img src="${data.imageUrl}" alt="Generated Image">
                        </div>
                    `;
                    
                    testResults.push({
                        test: `手动生成_${prompt.substring(0,20)}`,
                        time: endTime - startTime,
                        success: true,
                        size: data.settings.size,
                        steps: data.settings.steps,
                        seed: data.performance.seed
                    });
                    updatePerformanceStats();
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 生成失败: ${data.error}</div>`;
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                resultsDiv.innerHTML = `<div class="result error">❌ 错误: ${error.message}</div>`;
            }
        }

        function updatePerformanceStats() {
            const statsDiv = document.getElementById('performance-stats');
            const successTests = testResults.filter(t => t.success);
            const avgTime = successTests.reduce((sum, t) => sum + t.time, 0) / successTests.length;
            
            statsDiv.innerHTML = `
                <p>📊 总测试: ${testResults.length}</p>
                <p>✅ 成功: ${successTests.length}</p>
                <p>⏱️ 平均时间: ${Math.round(avgTime)}ms</p>
                <p>🚀 最快: ${Math.min(...successTests.map(t => t.time))}ms</p>
                <p>🐌 最慢: ${Math.max(...successTests.map(t => t.time))}ms</p>
            `;
        }

        async function testGhibliCharacteristics() {
            const resultsDiv = document.getElementById('style-results');
            resultsDiv.innerHTML = '<div class="result loading">测试吉卜力风格特征...</div>';
            
            const result = await apiTest('gentle girl with soft smile in a peaceful garden', '1:1', 'standard', '吉卜力特征测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasGhibliKeywords = prompt.includes('studio ghibli') && 
                                        prompt.includes('soft') && 
                                        prompt.includes('gentle') &&
                                        prompt.includes('hand-drawn');
                
                const avoidsRealistic = negativePrompt.includes('photorealistic') && 
                                      negativePrompt.includes('3d render') &&
                                      negativePrompt.includes('over-detailed');
                
                if (hasGhibliKeywords && avoidsRealistic) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 吉卜力风格特征完整
                    <br>包含关键词: Studio Ghibli, soft, gentle, hand-drawn
                    <br>避免写实化: photorealistic, 3D render被禁止
                    <br>提示词长度: ${result.data.prompt.length}
                    <br>负面提示词长度: ${result.data.negativePrompt.length}</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 吉卜力特征不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 特征测试失败: ${result.error}</div>`;
            }
        }

        async function testColorPalette() {
            const resultsDiv = document.getElementById('style-results');
            resultsDiv.innerHTML = '<div class="result loading">测试色彩柔和度...</div>';
            
            const result = await apiTest('sunset over meadow with wildflowers', '16:9', 'hd', '色彩测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasSoftColors = prompt.includes('soft muted colors') && 
                                    prompt.includes('low saturation') && 
                                    prompt.includes('gentle color harmony');
                
                const avoidsHarshColors = negativePrompt.includes('oversaturated') && 
                                        negativePrompt.includes('neon colors') &&
                                        negativePrompt.includes('high contrast');
                
                if (hasSoftColors && avoidsHarshColors) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 色彩系统优化完成
                    <br>柔和色彩: soft muted colors, low saturation
                    <br>避免刺眼: oversaturated, neon colors被禁止
                    <br>生成时间: ${result.time}ms</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 色彩优化不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 色彩测试失败: ${result.error}</div>`;
            }
        }

        async function testNaturalElements() {
            const resultsDiv = document.getElementById('style-results');
            resultsDiv.innerHTML = '<div class="result loading">测试自然元素...</div>';
            
            const result = await apiTest('forest path with dappled sunlight', '3:4', 'standard', '自然元素测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasNature = prompt.includes('nature landscapes') && 
                                prompt.includes('peaceful countryside') && 
                                prompt.includes('serene forests');
                
                const avoidsModern = negativePrompt.includes('modern') && 
                                   negativePrompt.includes('technology') &&
                                   negativePrompt.includes('urban cityscape');
                
                if (hasNature && avoidsModern) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 自然元素完整融入
                    <br>自然景观: nature landscapes, countryside, forests
                    <br>避免现代: modern, technology被排除
                    <br>氛围营造: peaceful, serene mood</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 自然元素不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 自然元素测试失败: ${result.error}</div>`;
            }
        }

        async function testAnatomyAccuracy() {
            const resultsDiv = document.getElementById('logic-results');
            resultsDiv.innerHTML = '<div class="result loading">测试解剖学准确性...</div>';
            
            const result = await apiTest('portrait of a girl with beautiful symmetrical face and natural hands', '1:1', 'hd', '解剖学准确性测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasAnatomyKeywords = prompt.includes('perfect human anatomy') && 
                                         prompt.includes('symmetrical facial features') && 
                                         prompt.includes('correct hand anatomy');
                
                const avoidsAnatomyErrors = negativePrompt.includes('asymmetrical eyes') && 
                                          negativePrompt.includes('extra fingers') &&
                                          negativePrompt.includes('malformed hands');
                
                if (hasAnatomyKeywords && avoidsAnatomyErrors) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 解剖学准确性系统完备
                    <br>包含: perfect human anatomy, symmetrical facial features
                    <br>排除: asymmetrical eyes, extra fingers, malformed hands
                    <br>生成时间: ${result.time}ms</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 解剖学准确性不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 解剖学测试失败: ${result.error}</div>`;
            }
        }

        async function testObjectLogic() {
            const resultsDiv = document.getElementById('logic-results');
            resultsDiv.innerHTML = '<div class="result loading">测试物体逻辑...</div>';
            
            const result = await apiTest('girl holding one flower in her hand', '3:4', 'hd', '物体逻辑测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasLogicKeywords = prompt.includes('single consistent object') && 
                                       prompt.includes('proper object interaction') && 
                                       prompt.includes('no penetrating objects');
                
                const avoidsLogicErrors = negativePrompt.includes('multiple same objects') && 
                                        negativePrompt.includes('penetrating objects') &&
                                        negativePrompt.includes('floating objects');
                
                if (hasLogicKeywords && avoidsLogicErrors) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 物体逻辑系统完善
                    <br>确保: single consistent object, proper interaction
                    <br>避免: multiple objects, penetrating, floating
                    <br>生成时间: ${result.time}ms</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 物体逻辑不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 物体逻辑测试失败: ${result.error}</div>`;
            }
        }

        async function testFacialSymmetry() {
            const resultsDiv = document.getElementById('logic-results');
            resultsDiv.innerHTML = '<div class="result loading">测试面部对称性...</div>';
            
            const result = await apiTest('close-up portrait of girl with perfectly symmetrical face', '1:1', 'hd', '面部对称性测试');
            
            if (result.success) {
                const prompt = result.data.prompt.toLowerCase();
                const negativePrompt = result.data.negativePrompt.toLowerCase();
                
                const hasFacialKeywords = prompt.includes('symmetrical eyes') && 
                                        prompt.includes('matching eye shapes') && 
                                        prompt.includes('properly aligned facial features');
                
                const avoidsFacialErrors = negativePrompt.includes('asymmetrical face') && 
                                         negativePrompt.includes('misaligned eyes') &&
                                         negativePrompt.includes('different eye styles');
                
                if (hasFacialKeywords && avoidsFacialErrors) {
                    resultsDiv.innerHTML = `<div class="result success">✅ 面部对称性系统优化
                    <br>确保: symmetrical eyes, matching shapes, aligned features
                    <br>避免: asymmetrical face, misaligned eyes
                    <br>推理步数: ${result.data.settings.steps}</div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="result error">❌ 面部对称性不完整</div>`;
                }
            } else {
                resultsDiv.innerHTML = `<div class="result error">❌ 面部对称性测试失败: ${result.error}</div>`;
            }
        }

        async function testComplexInteractions() {
            const resultsDiv = document.getElementById('logic-results');
            resultsDiv.innerHTML = '<div class="result loading">测试复杂交互场景...</div>';
            
            const complexScenarios = [
                'girl sitting on single chair reading one book',
                'character holding exactly one object with both hands',
                'person walking with proper body proportions'
            ];
            
            let results = '';
            for (const scenario of complexScenarios) {
                const result = await apiTest(scenario, '4:3', 'standard', `复杂交互_${scenario.substring(0,15)}`);
                if (result.success) {
                    results += `<div class="result success">✅ ${scenario.substring(0,30)}...: ${result.time}ms</div>`;
                } else {
                    results += `<div class="result error">❌ ${scenario.substring(0,30)}...: ${result.error}</div>`;
                }
            }
            resultsDiv.innerHTML = results;
        }

        // 页面加载时显示状态
        window.onload = function() {
            console.log('🎨 Ghibli AI 顶级质量图片生成器已准备就绪！');
        };
    </script>
</body>
</html> 